LOCAL_DIR := $(PWD)

ifndef FINS_ROOT_DIR
export FINS_ROOT_DIR := $(abspath $(LOCAL_DIR)/..)
endif

# fins.mk contains the compiler and linker options for each target platform
include $(FINS_ROOT_DIR)/settings.finsmk

#This is the Module name. This MUST be that same as the current directory!!!
PROJECT_NAME = tests

TESTS_INC = 

#Additional includes for FINS core modules
CFLAGS += $(TESTS_INC)

#add the names of any executables that are added to this directory here.  This
#ensures that they will be removed by clean
EXECUTABLES = server_icmp client_icmp server_tcp client_tcp server_udp client_udp  server_forks test speed_tcp speed_udp

#This is an autogenerated list of includes used in this project.
INCLUDES = $(foreach DIR_NAME, $(subst -I,, $(strip $(TESTS_INC))), $(addprefix $(DIR_NAME)/, $(shell ls $(DIR_NAME) 2> /dev/null | grep \\.h)))




##### TARGETS #####
.PHONY:all
all:$(EXECUTABLES) userspace_tests
	@echo "compiled[$(MAKELEVEL)]:'$(PROJECT_NAME)'\n"

client_icmp:client_icmp.c
	@$(CC) $(CFLAGS) -c $<
	@$(LD) $@.o $(LDFLAGS) -o $@

client_tcp:client_tcp.c
	@$(CC) $(CFLAGS) -c $<
	@$(LD) $@.o $(LDFLAGS) -o $@

client_udp:client_udp.c
	@$(CC) $(CFLAGS) -c $<
	@$(LD) $@.o $(LDFLAGS) -o $@

server_icmp:server_icmp.c
	@$(CC) $(CFLAGS) -c $<
	@$(LD) $@.o $(LDFLAGS) -o $@

server_tcp:server_tcp.c
	@$(CC) $(CFLAGS) -c $<
	@$(LD) $@.o $(LDFLAGS) -o $@

server_udp:server_udp.c
	@$(CC) $(CFLAGS) -c $<
	@$(LD) $@.o $(LDFLAGS) -o $@

server_forks:server_forks.c
	@$(CC) $(CFLAGS) -c $<
	@$(LD) $@.o $(LDFLAGS) -o $@

test:test.c
	@$(CC) $(CFLAGS) -c $<
	@$(LD) $@.o $(LDFLAGS) -o $@

userspace_tests:
	@cd Userspace_tests; make all

.PHONY:speed_tcp
speed_tcp:speed_tcp_client speed_tcp_server
	@echo "compiled[$(MAKELEVEL)]:'speed_tcp'"

speed_tcp_client:speed_tcp_client.c
	@$(CC) $(CFLAGS) -c $<
	@$(LD) $@.o $(LDFLAGS) -o $@

speed_tcp_server:speed_tcp_server.c
	@$(CC) $(CFLAGS) -c $<
	@$(LD) $@.o $(LDFLAGS) -o $@

.PHONY:speed_udp
speed_udp:speed_udp_client speed_udp_server
	@echo "compiled[$(MAKELEVEL)]:'speed_udp'"

speed_udp_client:speed_udp_client.c
	@$(CC) $(CFLAGS) -c $<
	@$(LD) $@.o $(LDFLAGS) -o $@

speed_udp_server:speed_udp_server.c
	@$(CC) $(CFLAGS) -c $<
	@$(LD) $@.o $(LDFLAGS) -o $@

.PHONY:clean
clean:
	@rm -f *.o 
	@rm -f $(EXECUTABLES) 
	@cd Userspace_tests; make clean; cd $(LOCAL_DIR)

.PHONY:clean_full
clean_full:
	@rm -f *.o 
	@rm -f $(EXECUTABLES) 
	@cd Userspace_tests; make clean; cd $(LOCAL_DIR)

.PHONY:install
install:
ifdef BUILD_FOR_ANDROID_ARM
	@adb push client_udp $(INSTALL_DIR)
	@adb push server_udp $(INSTALL_DIR)
	@adb push client_tcp $(INSTALL_DIR)
	@adb push server_tcp $(INSTALL_DIR)
else
	@echo "" > /dev/null
endif